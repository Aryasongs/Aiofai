<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Orion+ | Advanced Business Intelligence Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK - Compatible with ai.oriontec.xyz -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Security Headers for ai.oriontec.xyz -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: ai.oriontec.xyz; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://ai.oriontec.xyz; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #333;
        }
        
        .card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: #2557a7;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-primary:hover {
            background: #1e4a8c;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-control:focus {
            border-color: #2557a7;
            outline: none;
            box-shadow: 0 0 0 2px rgba(37, 87, 167, 0.25);
        }
        
        .progress-bar {
            transition: width 0.3s ease;
            background: #2557a7;
        }
        
        .radio-option {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .radio-option:hover {
            border-color: #2557a7;
            background: #f8f9ff;
        }
        
        .radio-option.selected {
            border-color: #2557a7;
            background: #f8f9ff;
        }
    </style>
</head>
<body>
    <div class="min-h-screen py-4 px-4">
        <div class="container mx-auto max-w-4xl">
            <!-- Authentication Screen -->
            <div id="authScreen" class="hidden">
                <div class="text-center mb-8">
                    <div class="flex items-center justify-center mb-4">
                        <div class="w-12 h-12 bg-blue-600 rounded flex items-center justify-center mr-3">
                            <svg class="w-8 h-8" fill="white" viewBox="0 0 24 24">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                            </svg>
                        </div>
                        <h1 class="text-4xl font-bold text-blue-600">Web Orion+</h1>
                    </div>
                    <p class="text-gray-600 text-lg">Advanced Business Intelligence Platform</p>
                    <div class="flex items-center justify-center mt-3">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-green-600 text-sm">🔒 Secure Authentication • SSL Protected</span>
                    </div>
                </div>

                <div class="card p-8 max-w-md mx-auto">
                    <div class="text-center mb-6">
                        <h2 id="authTitle" class="text-2xl font-bold mb-2">Login to Web Orion+</h2>
                        <p id="authSubtitle" class="text-gray-600">Enter your credentials to access the platform</p>
                    </div>

                    <!-- Login Form -->
                    <div id="loginForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Email Address</label>
                                <input type="email" id="loginEmail" class="form-control" placeholder="your.email@company.com" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Password</label>
                                <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                            </div>
                            <button onclick="loginUser()" class="btn-primary w-full">
                                🔐 Login to Web Orion+
                            </button>
                        </div>
                        
                        <div class="text-center mt-6">
                            <p class="text-gray-600">Don't have an account?</p>
                            <button onclick="showRegisterForm()" class="text-blue-600 hover:text-blue-800 font-medium">
                                Create New Account
                            </button>
                            <div class="mt-3">
                                <button onclick="resetPassword()" class="text-sm text-gray-500 hover:text-gray-700">
                                    Forgot Password?
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Registration Form -->
                    <div id="registerForm" class="hidden">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Country *</label>
                                <select id="regCountry" class="form-control" required>
                                    <option value="">Select Your Country</option>
                                    <option value="us">🇺🇸 United States</option>
                                    <option value="uk">🇬🇧 United Kingdom</option>
                                    <option value="ca">🇨🇦 Canada</option>
                                    <option value="au">🇦🇺 Australia</option>
                                    <option value="in">🇮🇳 India</option>
                                    <option value="de">🇩🇪 Germany</option>
                                    <option value="fr">🇫🇷 France</option>
                                    <option value="jp">🇯🇵 Japan</option>
                                    <option value="sg">🇸🇬 Singapore</option>
                                    <option value="ae">🇦🇪 UAE</option>
                                    <option value="other">🌍 Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Email Address *</label>
                                <input type="email" id="regEmail" class="form-control" placeholder="your.email@company.com" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Password *</label>
                                <input type="password" id="regPassword" class="form-control" placeholder="Minimum 6 characters" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Confirm Password *</label>
                                <input type="password" id="regConfirmPassword" class="form-control" placeholder="Re-enter your password" required>
                            </div>
                            <button onclick="registerUser()" class="btn-success w-full">
                                ✅ Create Account
                            </button>
                        </div>
                        
                        <div class="text-center mt-6">
                            <p class="text-gray-600">Already have an account?</p>
                            <button onclick="showLoginForm()" class="text-blue-600 hover:text-blue-800 font-medium">
                                Login Here
                            </button>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-6 text-sm text-gray-500">
                    <p>🔒 Your data is encrypted and secure</p>
                    <p>By using Web Orion+, you agree to our Terms of Service</p>
                </div>
            </div>

            <!-- Main Application (shown after authentication) -->
            <div id="mainApp" class="hidden">
                <!-- Header -->
                <div class="text-center mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center mr-3">
                                <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <h1 class="text-3xl font-bold text-blue-600">Web Orion+</h1>
                        </div>
                        
                        <!-- User Info & Logout -->
                        <div class="flex items-center space-x-4">
                            <div class="text-right text-sm">
                                <p class="text-gray-600">Welcome back!</p>
                                <p class="font-medium" id="userEmail">user@example.com</p>
                                <p class="text-xs text-gray-500">
                                    <span id="userCountry">Country</span> • Member since <span id="userSince">Date</span>
                                </p>
                            </div>
                            <button onclick="showAdminPanel()" class="btn-success text-sm mr-2" id="adminBtn" style="display: none;">
                                👨‍💼 Admin
                            </button>
                            <button onclick="logoutUser()" class="btn-secondary text-sm">
                                🚪 Logout
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-600">Advanced Business Intelligence Platform</p>
                    <div class="flex items-center justify-center mt-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-green-600 text-sm">System Online • SSL Verified for ai.oriontec.xyz</span>
                    </div>
                    
                    <!-- Navigation Buttons -->
                    <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4 mt-4">
                        <button onclick="showHome()" class="btn-primary">🏠 New Application</button>
                        <button onclick="showTracker()" class="btn-secondary">📋 Track Application</button>
                    </div>
                </div>

                <!-- Main Container -->
                <div class="card p-6 md:p-8">
                
                <!-- Admin Panel Screen -->
                <div id="adminScreen" class="hidden">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold mb-4 text-red-600">👨‍💼 Admin Control Panel</h2>
                        <p class="text-gray-600">Manage candidate applications and approvals</p>
                    </div>
                    
                    <!-- Admin Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="card p-4 bg-blue-50">
                            <div class="text-2xl font-bold text-blue-600" id="totalApplications">0</div>
                            <div class="text-sm text-blue-800">Total Applications</div>
                        </div>
                        <div class="card p-4 bg-yellow-50">
                            <div class="text-2xl font-bold text-yellow-600" id="pendingApplications">0</div>
                            <div class="text-sm text-yellow-800">Pending Review</div>
                        </div>
                        <div class="card p-4 bg-green-50">
                            <div class="text-2xl font-bold text-green-600" id="approvedApplications">0</div>
                            <div class="text-sm text-green-800">Approved</div>
                        </div>
                        <div class="card p-4 bg-red-50">
                            <div class="text-2xl font-bold text-red-600" id="rejectedApplications">0</div>
                            <div class="text-sm text-red-800">Rejected</div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <input type="text" id="adminSearch" class="form-control flex-1" placeholder="Search by ID, Name, Email, or Company...">
                        <select id="statusFilter" class="form-control md:w-48">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="interview_ready">Interview Ready</option>
                            <option value="completed">Completed</option>
                        </select>
                        <button onclick="loadAdminData()" class="btn-primary">🔄 Refresh</button>
                    </div>
                    
                    <!-- Applications Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 p-3 text-left">Application ID</th>
                                    <th class="border border-gray-300 p-3 text-left">Candidate</th>
                                    <th class="border border-gray-300 p-3 text-left">Company</th>
                                    <th class="border border-gray-300 p-3 text-left">Score</th>
                                    <th class="border border-gray-300 p-3 text-left">Status</th>
                                    <th class="border border-gray-300 p-3 text-left">Date</th>
                                    <th class="border border-gray-300 p-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="mt-6 flex flex-wrap gap-2">
                        <button onclick="bulkApprove()" class="btn-success text-sm">✅ Bulk Approve Selected</button>
                        <button onclick="bulkReject()" class="btn-secondary text-sm">❌ Bulk Reject Selected</button>
                        <button onclick="exportData()" class="btn-primary text-sm">📊 Export Data</button>
                    </div>
                </div>
                
                <!-- Application Tracker Screen -->
                <div id="trackerScreen" class="hidden">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold mb-4">Track Your Application</h2>
                        <p class="text-gray-600">Enter your Application ID to check status</p>
                    </div>
                    
                    <div class="max-w-md mx-auto mb-6">
                        <label class="block text-sm font-medium mb-2">Application ID</label>
                        <div class="flex space-x-2">
                            <input type="text" id="trackingId" class="form-control" placeholder="WO-XXXXXXX-XXXX">
                            <button onclick="trackApplication()" class="btn-primary">Track</button>
                        </div>
                    </div>
                    
                    <div id="trackingResult" class="hidden">
                        <!-- Application Status -->
                        <div class="card p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold">Application Status</h3>
                                <span id="statusBadge" class="px-3 py-1 rounded text-sm font-medium"></span>
                            </div>
                            
                            <!-- Progress Steps -->
                            <div class="space-y-4" id="progressSteps">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">✓</div>
                                    <div>
                                        <p class="font-medium">Application Submitted</p>
                                        <p class="text-sm text-gray-600" id="submitDate"></p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center" id="reviewStep">
                                    <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">⏳</div>
                                    <div>
                                        <p class="font-medium">Under Review</p>
                                        <p class="text-sm text-gray-600">Processing your application...</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center" id="approvedStep" style="display: none;">
                                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">✓</div>
                                    <div>
                                        <p class="font-medium">Application Approved</p>
                                        <p class="text-sm text-gray-600">Ready for next steps</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center" id="allotmentStep" style="display: none;">
                                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">📋</div>
                                    <div>
                                        <p class="font-medium">Allotment Number Required</p>
                                        <p class="text-sm text-gray-600">Enter your allotment number to proceed</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center" id="interviewStep" style="display: none;">
                                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">🎤</div>
                                    <div>
                                        <p class="font-medium">Interview Scheduled</p>
                                        <p class="text-sm text-gray-600">Complete your interview assessment</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Allotment Number Input -->
                            <div id="allotmentInput" class="mt-6 hidden">
                                <div class="alert alert-warning mb-4">
                                    <p><strong>Next Step:</strong> Enter your allotment number to proceed to interview</p>
                                </div>
                                <div class="flex space-x-2">
                                    <input type="text" id="allotmentNumber" class="form-control" placeholder="Enter Allotment Number">
                                    <button onclick="submitAllotment()" class="btn-success">Submit</button>
                                </div>
                            </div>
                            
                            <!-- Interview Button -->
                            <div id="interviewButton" class="mt-6 hidden">
                                <div class="alert alert-success mb-4">
                                    <p><strong>Ready for Interview:</strong> Complete your final assessment</p>
                                </div>
                                <button onclick="startInterview()" class="btn-primary w-full">Start Interview Assessment</button>
                            </div>
                        </div>
                        
                        <!-- Application PDF -->
                        <div class="card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold">Application Details</h3>
                                <button onclick="downloadPDF()" class="btn-secondary">📄 Download PDF</button>
                            </div>
                            
                            <div id="applicationDetails" class="space-y-3">
                                <!-- Details will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Camera Access Screen -->
                <div id="cameraScreen" class="text-center">
                    <div class="mb-6">
                        <div class="text-4xl mb-4">📹</div>
                        <h2 class="text-2xl font-bold mb-4">Security Verification Required</h2>
                        <div class="alert alert-warning">
                            <p class="mb-2"><strong>Important:</strong> To ensure exam integrity and prevent cheating, we need to:</p>
                            <ul class="text-left list-disc list-inside space-y-1">
                                <li>Monitor your camera during the assessment</li>
                                <li>Record audio to detect unauthorized assistance</li>
                                <li>Track if you leave this page (questions will change)</li>
                                <li>Verify your identity throughout the process</li>
                            </ul>
                        </div>
                        <p class="text-gray-600 mb-4">Please grant camera and microphone access to continue.</p>
                    </div>
                    <div class="space-y-3">
                        <button onclick="requestCameraFirst()" class="btn-primary w-full md:w-auto">
                            📹 Enable Camera Access
                        </button>
                        <button onclick="requestMicFirst()" class="btn-primary w-full md:w-auto ml-0 md:ml-3">
                            🎤 Enable Microphone Access
                        </button>
                    </div>
                    <div id="accessStatus" class="mt-4"></div>
                    <button id="proceedBtn" onclick="showWelcome()" class="btn-success w-full mt-4 hidden">
                        Proceed to Verification
                    </button>
                </div>

                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="text-center hidden">
                    <div class="mb-6">
                        <div class="text-4xl mb-4">🚨</div>
                        <h2 class="text-2xl font-bold mb-4 text-red-600">SECURITY CHECKPOINT</h2>
                        <div class="alert alert-warning">
                            <p id="welcomeText">To enter Web Orion+, you must pass our advanced global screening process. This verifies your thinking, logic, business credibility, and international compliance. Please respond truthfully. Every answer is AI-analyzed. If you leave mid-way, all progress resets.</p>
                        </div>
                    </div>
                    <button onclick="startVerification()" class="btn-primary">
                        BEGIN VERIFICATION
                    </button>
                </div>

                <!-- Progress Bar -->
                <div id="progressContainer" class="hidden mb-6">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Verification Progress</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded h-2">
                        <div id="progressBar" class="progress-bar h-2 rounded" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Business Assessment -->
                <div id="assessmentScreen" class="hidden">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold mb-2">Business Intelligence Assessment</h3>
                        <p class="text-gray-600">Level: <span id="currentLevel" class="text-blue-600 font-semibold">Manager</span></p>
                    </div>
                    
                    <div class="card p-6 mb-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                            <span class="text-sm text-gray-600 mb-2 sm:mb-0">Question <span id="questionNumber">1</span> of 10</span>
                            <span class="text-sm text-gray-600">Score: <span id="currentScore" class="text-green-600 font-semibold">0</span>/30</span>
                        </div>
                        <h4 class="text-lg font-semibold mb-4" id="questionText"></h4>
                        <div id="optionsContainer" class="space-y-2"></div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between space-y-2 sm:space-y-0">
                        <button id="prevBtn" onclick="previousQuestion()" class="btn-secondary" disabled>
                            Previous
                        </button>
                        <button id="nextBtn" onclick="nextQuestion()" class="btn-primary" disabled>
                            Next Question
                        </button>
                    </div>
                </div>

                <!-- Professional Details -->
                <div id="detailsScreen" class="hidden">
                    <h3 class="text-xl font-bold mb-6">Professional Verification</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Full Name *</label>
                            <input type="text" id="fullName" class="form-control">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Business Email *</label>
                            <input type="email" id="businessEmail" class="form-control">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Company Name *</label>
                            <input type="text" id="companyName" class="form-control">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Job Title *</label>
                            <select id="jobTitle" class="form-control">
                                <option value="">Select Position</option>
                                <option value="manager">Manager</option>
                                <option value="director">Director</option>
                                <option value="ceo">CEO/Founder</option>
                                <option value="vp">Vice President</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Country *</label>
                            <select id="country" class="form-control">
                                <option value="">Select Country</option>
                                <option value="us">United States</option>
                                <option value="uk">United Kingdom</option>
                                <option value="ca">Canada</option>
                                <option value="au">Australia</option>
                                <option value="in">India</option>
                                <option value="de">Germany</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Years of Experience *</label>
                            <select id="experience" class="form-control">
                                <option value="">Select Experience</option>
                                <option value="1-3">1-3 years</option>
                                <option value="4-7">4-7 years</option>
                                <option value="8-15">8-15 years</option>
                                <option value="15+">15+ years</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="submitDetails()" class="btn-success w-full mt-6">
                        SUBMIT APPLICATION
                    </button>
                </div>

                <!-- Interview Assessment Screen -->
                <div id="interviewScreen" class="hidden">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold mb-2 text-red-600">🎤 FINAL INTERVIEW ASSESSMENT</h3>
                        <div class="alert alert-danger">
                            <p><strong>⚠️ CRITICAL WARNING:</strong> This is your final interview. If you leave this page for even 1 second, all questions will change and you'll have to restart. Stay focused!</p>
                        </div>
                        <p class="text-gray-600">Advanced Level Questions - Answer 10+ correctly to pass</p>
                    </div>
                    
                    <div class="card p-6 mb-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                            <span class="text-sm text-gray-600 mb-2 sm:mb-0">Interview Question <span id="interviewQuestionNumber">1</span> of 15</span>
                            <span class="text-sm text-gray-600">Correct: <span id="interviewScore" class="text-green-600 font-semibold">0</span>/15</span>
                        </div>
                        <h4 class="text-lg font-semibold mb-4" id="interviewQuestionText"></h4>
                        <div id="interviewOptionsContainer" class="space-y-2"></div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between space-y-2 sm:space-y-0">
                        <button id="interviewPrevBtn" onclick="previousInterviewQuestion()" class="btn-secondary" disabled>
                            Previous
                        </button>
                        <button id="interviewNextBtn" onclick="nextInterviewQuestion()" class="btn-primary" disabled>
                            Next Question
                        </button>
                    </div>
                </div>

                <!-- Results Screen -->
                <div id="resultsScreen" class="hidden text-center">
                    <div id="successResult" class="hidden">
                        <div class="text-4xl mb-4">✅</div>
                        <h3 class="text-2xl font-bold text-green-600 mb-4">VERIFICATION SUCCESSFUL</h3>
                        <div class="alert alert-success mb-6">
                            <p class="text-lg mb-2">Final Score: <span id="finalScore" class="font-bold"></span>/30</p>
                            <p>You have successfully qualified for Web Orion+ access.</p>
                            <div class="mt-4 p-4 bg-gray-100 rounded">
                                <p class="text-sm text-gray-600">Application ID:</p>
                                <p class="font-mono text-blue-600" id="applicationId"></p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <p class="text-gray-600 mb-4">Your application is now being processed. You will receive an email notification once approved.</p>
                            <div class="alert alert-warning">
                                <p><strong>Status:</strong> Pending Review</p>
                                <p class="text-sm">Expected processing time: 2-3 business days</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="failResult" class="hidden">
                        <div class="text-4xl mb-4">❌</div>
                        <h3 class="text-2xl font-bold text-red-600 mb-4">ACCESS DENIED</h3>
                        <div class="alert alert-danger mb-6">
                            <p class="text-lg mb-2">Final Score: <span id="failScore" class="font-bold"></span>/30</p>
                            <p>Minimum required score: 18/30</p>
                            <p class="mt-2">Please strengthen your business fundamentals and try again.</p>
                        </div>
                        <button onclick="restartVerification()" class="btn-secondary">
                            Try Again
                        </button>
                    </div>
                    
                    <div id="interviewSuccessResult" class="hidden">
                        <div class="text-4xl mb-4">🎉</div>
                        <h3 class="text-2xl font-bold text-green-600 mb-4">INTERVIEW PASSED!</h3>
                        <div class="alert alert-success mb-6">
                            <p class="text-lg mb-2">Interview Score: <span id="finalInterviewScore" class="font-bold"></span>/15</p>
                            <p>Congratulations! You have successfully completed all assessments.</p>
                            <div class="mt-4 p-4 bg-gray-100 rounded">
                                <p class="text-sm text-gray-600">Final Status:</p>
                                <p class="font-bold text-green-600">FULLY APPROVED FOR WEB ORION+ ACCESS</p>
                            </div>
                        </div>
                        <button onclick="showHome()" class="btn-primary">
                            Return to Home
                        </button>
                    </div>
                    
                    <div id="interviewFailResult" class="hidden">
                        <div class="text-4xl mb-4">❌</div>
                        <h3 class="text-2xl font-bold text-red-600 mb-4">INTERVIEW FAILED</h3>
                        <div class="alert alert-danger mb-6">
                            <p class="text-lg mb-2">Interview Score: <span id="failInterviewScore" class="font-bold"></span>/15</p>
                            <p>Minimum required: 10/15 correct answers</p>
                            <p class="mt-2">Your application has been rejected. Please reapply after improving your skills.</p>
                        </div>
                        <button onclick="showHome()" class="btn-secondary">
                            Return to Home
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - Your Project
        const firebaseConfig = {
            apiKey: "AIzaSyAl8eI-_8Ew9va0KPV8p4D2hc9WUTGiwuI",
            authDomain: "chat-d647c.firebaseapp.com",
            databaseURL: "https://chat-d647c-default-rtdb.firebaseio.com",
            projectId: "chat-d647c",
            storageBucket: "chat-d647c.firebasestorage.app",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:7248a0983dcf0d45a87418",
            measurementId: "G-5RFLRYTLCN"
        };

        // Initialize Firebase with error handling
        let db = null;
        let auth = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log('✅ Firebase initialized successfully with Authentication');
        } catch (error) {
            console.error('❌ Firebase initialization error:', error);
            // Fallback to local storage
        }

        let currentQuestion = 0;
        let score = 0;
        let userAnswers = [];
        let questions = [];
        let userLevel = 'manager';
        let pageVisible = true;
        let cameraGranted = false;
        let micGranted = false;
        let mediaStream = null;
        
        // Interview variables
        let currentInterviewQuestion = 0;
        let interviewScore = 0;
        let interviewAnswers = [];
        let interviewQuestions = [];
        let applicationData = {};
        let isInterviewMode = false;

        // Firebase Database Functions
        async function initializeSampleData() {
            try {
                // Check if sample data already exists
                const snapshot = await db.collection('candidates').limit(1).get();
                if (!snapshot.empty) {
                    console.log('Sample data already exists in Firebase');
                    return;
                }

                // Sample candidate data to populate Firebase
                const sampleCandidates = [
                    {
                        id: 'WO-1K2L3M4N-ABCD',
                        status: 'pending',
                        submitDate: '2024-01-15',
                        fullName: 'Rajesh Kumar Singh',
                        email: 'rajesh.singh@techcorp.com',
                        company: 'TechCorp Solutions Pvt Ltd',
                        position: 'Senior Manager',
                        country: 'India',
                        experience: '8-15 years',
                        score: '27/30',
                        level: 'manager',
                        phone: '+91-9876543210',
                        allotmentNumber: null,
                        interviewScore: null,
                        applicationDate: firebase.firestore.Timestamp.fromDate(new Date('2024-01-15T10:30:00Z'))
                    },
                    {
                        id: 'WO-5P6Q7R8S-EFGH',
                        status: 'approved',
                        submitDate: '2024-01-12',
                        fullName: 'Priya Sharma',
                        email: 'priya.sharma@innovatetech.in',
                        company: 'InnovateTech India',
                        position: 'Director',
                        country: 'India',
                        experience: '15+ years',
                        score: '29/30',
                        level: 'director',
                        phone: '+91-9123456789',
                        allotmentNumber: null,
                        interviewScore: null,
                        applicationDate: firebase.firestore.Timestamp.fromDate(new Date('2024-01-12T14:45:00Z'))
                    },
                    {
                        id: 'WO-9T0U1V2W-IJKL',
                        status: 'interview_ready',
                        submitDate: '2024-01-10',
                        fullName: 'Amit Patel',
                        email: 'amit.patel@globalventures.com',
                        company: 'Global Ventures Ltd',
                        position: 'CEO/Founder',
                        country: 'India',
                        experience: '15+ years',
                        score: '30/30',
                        level: 'ceo',
                        phone: '+91-9988776655',
                        allotmentNumber: 'ALT-2024-001',
                        interviewScore: null,
                        applicationDate: firebase.firestore.Timestamp.fromDate(new Date('2024-01-10T09:15:00Z'))
                    },
                    {
                        id: 'WO-3X4Y5Z6A-MNOP',
                        status: 'pending',
                        submitDate: '2024-01-18',
                        fullName: 'Sneha Gupta',
                        email: 'sneha.gupta@digitalsolutions.co.in',
                        company: 'Digital Solutions India',
                        position: 'Vice President',
                        country: 'India',
                        experience: '4-7 years',
                        score: '25/30',
                        level: 'director',
                        phone: '+91-8765432109',
                        allotmentNumber: null,
                        interviewScore: null,
                        applicationDate: firebase.firestore.Timestamp.fromDate(new Date('2024-01-18T16:20:00Z'))
                    },
                    {
                        id: 'WO-7B8C9D0E-QRST',
                        status: 'approved',
                        submitDate: '2024-01-14',
                        fullName: 'Vikram Mehta',
                        email: 'vikram.mehta@businesshub.in',
                        company: 'Business Hub Solutions',
                        position: 'Manager',
                        country: 'India',
                        experience: '4-7 years',
                        score: '23/30',
                        level: 'manager',
                        phone: '+91-7654321098',
                        allotmentNumber: null,
                        interviewScore: null,
                        applicationDate: firebase.firestore.Timestamp.fromDate(new Date('2024-01-14T11:30:00Z'))
                    },
                    {
                        id: 'WO-1F2G3H4I-UVWX',
                        status: 'completed',
                        submitDate: '2024-01-08',
                        fullName: 'Anita Desai',
                        email: 'anita.desai@smartenterprises.com',
                        company: 'Smart Enterprises Pvt Ltd',
                        position: 'Director',
                        country: 'India',
                        experience: '8-15 years',
                        score: '28/30',
                        level: 'director',
                        phone: '+91-6543210987',
                        allotmentNumber: 'ALT-2024-002',
                        interviewScore: '13/15',
                        applicationDate: firebase.firestore.Timestamp.fromDate(new Date('2024-01-08T13:45:00Z')),
                        finalStatus: 'APPROVED - Full Access Granted'
                    }
                ];

                // Add sample data to Firebase
                const batch = db.batch();
                sampleCandidates.forEach(candidate => {
                    const docRef = db.collection('candidates').doc(candidate.id);
                    batch.set(docRef, candidate);
                });

                await batch.commit();
                console.log('✅ Sample data added to Firebase successfully!');
                showAlert('🔥 Firebase database initialized with sample data!', 'success');
            } catch (error) {
                console.error('Error initializing sample data:', error);
                showAlert('⚠️ Using local data - Firebase connection failed', 'warning');
            }
        }

        // Save candidate to Firebase
        async function saveCandidateToFirebase(candidateData) {
            try {
                await db.collection('candidates').doc(candidateData.id).set({
                    ...candidateData,
                    applicationDate: firebase.firestore.Timestamp.fromDate(new Date()),
                    createdAt: firebase.firestore.Timestamp.now()
                });
                console.log('✅ Candidate saved to Firebase:', candidateData.id);
                return true;
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                showAlert('⚠️ Data saved locally - Firebase sync failed', 'warning');
                return false;
            }
        }

        // Get candidate from Firebase
        async function getCandidateFromFirebase(applicationId) {
            try {
                const doc = await db.collection('candidates').doc(applicationId).get();
                if (doc.exists) {
                    const data = doc.data();
                    // Convert Firestore timestamp to readable date
                    if (data.applicationDate && data.applicationDate.toDate) {
                        data.applicationDate = data.applicationDate.toDate().toISOString();
                    }
                    console.log('✅ Candidate found in Firebase:', applicationId);
                    return data;
                } else {
                    console.log('❌ Candidate not found in Firebase:', applicationId);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching from Firebase:', error);
                showAlert('⚠️ Firebase connection error - using local data', 'warning');
                return null;
            }
        }

        // Update candidate in Firebase
        async function updateCandidateInFirebase(applicationId, updateData) {
            try {
                await db.collection('candidates').doc(applicationId).update({
                    ...updateData,
                    updatedAt: firebase.firestore.Timestamp.now()
                });
                console.log('✅ Candidate updated in Firebase:', applicationId);
                return true;
            } catch (error) {
                console.error('Error updating Firebase:', error);
                showAlert('⚠️ Update saved locally - Firebase sync failed', 'warning');
                return false;
            }
        }

        // Get all candidates from Firebase (for admin use)
        async function getAllCandidatesFromFirebase() {
            try {
                const snapshot = await db.collection('candidates').orderBy('applicationDate', 'desc').get();
                const candidates = [];
                snapshot.forEach(doc => {
                    candidates.push({ id: doc.id, ...doc.data() });
                });
                console.log(`✅ Retrieved ${candidates.length} candidates from Firebase`);
                return candidates;
            } catch (error) {
                console.error('Error fetching all candidates:', error);
                return [];
            }
        }

        // Interview Questions (Advanced Level)
        const interviewQuestionBank = [
            {
                question: "What is the primary difference between Series A and Series B funding rounds?",
                options: [
                    "Series A is for product development, Series B is for market expansion",
                    "Series A is smaller amounts, Series B is for scaling operations",
                    "Series A is for startups, Series B is for established companies",
                    "There is no significant difference"
                ],
                correct: 1
            },
            {
                question: "In SaaS metrics, what does 'Net Revenue Retention' measure?",
                options: [
                    "Total revenue minus costs",
                    "Revenue growth from existing customers including upgrades and churn",
                    "New customer revenue only",
                    "Gross revenue retention"
                ],
                correct: 1
            },
            {
                question: "What is the 'Rule of 40' in SaaS business evaluation?",
                options: [
                    "40% profit margin requirement",
                    "Growth rate + profit margin should exceed 40%",
                    "40% customer retention rate",
                    "40% market share target"
                ],
                correct: 1
            },
            {
                question: "What does 'Product-Led Growth' (PLG) primarily focus on?",
                options: [
                    "Using the product itself as the main driver of customer acquisition",
                    "Product development speed",
                    "Product pricing strategies",
                    "Product marketing campaigns"
                ],
                correct: 0
            },
            {
                question: "In international business, what is 'Transfer Pricing'?",
                options: [
                    "Pricing products for international markets",
                    "Setting prices for transactions between related companies in different countries",
                    "Currency exchange pricing",
                    "Import/export pricing"
                ],
                correct: 1
            },
            {
                question: "What is the primary purpose of a 'Minimum Viable Product' (MVP)?",
                options: [
                    "To create the cheapest possible product",
                    "To test core hypotheses with minimal resources",
                    "To compete with existing products",
                    "To satisfy all customer needs"
                ],
                correct: 1
            },
            {
                question: "What does 'Churn Rate' specifically measure in subscription businesses?",
                options: [
                    "Customer acquisition rate",
                    "The percentage of customers who cancel their subscriptions",
                    "Revenue growth rate",
                    "Product usage frequency"
                ],
                correct: 1
            },
            {
                question: "In venture capital, what is a 'Liquidation Preference'?",
                options: [
                    "The order in which investors get paid during a company sale or liquidation",
                    "The preference for liquid investments",
                    "The right to liquidate investments early",
                    "A type of stock option"
                ],
                correct: 0
            },
            {
                question: "What is 'Unit Economics' in business analysis?",
                options: [
                    "The economics of manufacturing units",
                    "Revenue and costs associated with a single unit of business",
                    "Economic units of measurement",
                    "Unit pricing strategies"
                ],
                correct: 1
            },
            {
                question: "What does 'TAM, SAM, SOM' represent in market analysis?",
                options: [
                    "Three types of marketing strategies",
                    "Total Addressable Market, Serviceable Addressable Market, Serviceable Obtainable Market",
                    "Target, Sales, and Marketing metrics",
                    "Three phases of business growth"
                ],
                correct: 1
            },
            {
                question: "What is 'Burn Rate' in startup terminology?",
                options: [
                    "The rate at which a company spends its cash reserves",
                    "Employee turnover rate",
                    "Product development speed",
                    "Market penetration rate"
                ],
                correct: 0
            },
            {
                question: "In B2B sales, what is 'Account-Based Marketing' (ABM)?",
                options: [
                    "Marketing based on accounting principles",
                    "Targeting specific high-value accounts with personalized campaigns",
                    "Marketing to bank accounts",
                    "Automated marketing systems"
                ],
                correct: 1
            },
            {
                question: "What is 'Gross Revenue Retention' (GRR) in SaaS?",
                options: [
                    "Total revenue retained from existing customers excluding upgrades",
                    "Gross profit retention",
                    "Revenue retention including new customers",
                    "Government revenue retention"
                ],
                correct: 0
            },
            {
                question: "What does 'PMF' stand for in startup terminology?",
                options: [
                    "Product-Market Fit",
                    "Profit Margin Factor",
                    "Product Management Framework",
                    "Performance Measurement Factor"
                ],
                correct: 0
            },
            {
                question: "In international expansion, what is 'Localization' vs 'Internationalization'?",
                options: [
                    "They are the same thing",
                    "Localization is adapting for specific markets, Internationalization is designing for global markets",
                    "Localization is cheaper than Internationalization",
                    "Internationalization comes before Localization"
                ],
                correct: 1
            }
        ];

        // Question banks for different levels
        const questionBanks = {
            manager: [
                {
                    question: "What is the most effective way to reduce Customer Acquisition Cost (CAC) for a B2B SaaS product?",
                    options: [
                        "Increase advertising spend",
                        "Focus on referral programs and content marketing",
                        "Lower product prices",
                        "Hire more sales representatives"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "In international business, what is the primary challenge when expanding to European markets?",
                    options: [
                        "Language barriers only",
                        "GDPR compliance and data protection laws",
                        "Currency exchange rates",
                        "Time zone differences"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "What does 'Product-Market Fit' mean in business strategy?",
                    options: [
                        "When your product price matches market expectations",
                        "When your product satisfies strong market demand",
                        "When your product features match competitors",
                        "When your product design fits market trends"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "Which metric is most important for measuring business growth sustainability?",
                    options: [
                        "Monthly revenue",
                        "Customer Lifetime Value (CLV) to CAC ratio",
                        "Number of employees",
                        "Social media followers"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "What is the best approach for pricing a SaaS product internationally?",
                    options: [
                        "Use the same price globally",
                        "Implement purchasing power parity pricing",
                        "Always charge premium in developed countries",
                        "Base pricing only on local competition"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "What is ROI in business terms?",
                    options: [
                        "Return on Investment",
                        "Rate of Interest",
                        "Revenue over Income",
                        "Risk of Investment"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What does B2B stand for?",
                    options: [
                        "Business to Business",
                        "Back to Back",
                        "Buy to Build",
                        "Brand to Brand"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What is the primary goal of market research?",
                    options: [
                        "Understanding customer needs and market trends",
                        "Increasing company profits",
                        "Reducing operational costs",
                        "Hiring more employees"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What does KPI stand for?",
                    options: [
                        "Key Performance Indicator",
                        "Key Profit Index",
                        "Knowledge Performance Index",
                        "Key Process Improvement"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What is the main purpose of a business plan?",
                    options: [
                        "To outline business goals and strategies",
                        "To impress investors only",
                        "To comply with legal requirements",
                        "To track daily expenses"
                    ],
                    correct: 0,
                    points: 3
                }
            ],
            director: [
                {
                    question: "What is the most critical factor in scaling a business from $1M to $10M ARR?",
                    options: [
                        "Hiring more developers",
                        "Building repeatable sales processes and systems",
                        "Expanding to more countries",
                        "Increasing marketing budget"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "In a freemium model, what's the optimal conversion rate from free to paid users?",
                    options: [
                        "1-2%",
                        "2-5%",
                        "10-15%",
                        "20-25%"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "What is the primary risk when expanding internationally without proper compliance?",
                    options: [
                        "Higher operational costs",
                        "Legal penalties and business shutdown",
                        "Cultural misunderstandings",
                        "Currency fluctuation losses"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "Which business model has the highest customer lifetime value potential?",
                    options: [
                        "One-time purchase",
                        "Subscription with usage-based pricing",
                        "Advertising-based",
                        "Commission-based marketplace"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "What is the most effective way to reduce churn in B2B SaaS?",
                    options: [
                        "Lower prices",
                        "Proactive customer success and onboarding",
                        "Add more features",
                        "Increase sales team size"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "What does EBITDA stand for?",
                    options: [
                        "Earnings Before Interest, Taxes, Depreciation, and Amortization",
                        "Estimated Business Income and Tax Analysis",
                        "Economic Business Investment Data Analysis",
                        "Enterprise Budget and Income Tax Assessment"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What is market segmentation?",
                    options: [
                        "Dividing market into distinct groups of customers",
                        "Increasing market share",
                        "Reducing market competition",
                        "Expanding to new markets"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What is a competitive advantage?",
                    options: [
                        "A unique benefit that makes a company better than competitors",
                        "Having more employees than competitors",
                        "Charging lower prices than competitors",
                        "Having more offices than competitors"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What does CRM stand for?",
                    options: [
                        "Customer Relationship Management",
                        "Customer Revenue Management",
                        "Company Resource Management",
                        "Customer Retention Model"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What is brand equity?",
                    options: [
                        "The value a brand adds to a product or service",
                        "The money invested in branding",
                        "The number of brand mentions",
                        "The cost of brand marketing"
                    ],
                    correct: 0,
                    points: 3
                }
            ],
            ceo: [
                {
                    question: "What is the most important metric for a CEO to track in a high-growth startup?",
                    options: [
                        "Monthly recurring revenue",
                        "Net revenue retention and unit economics",
                        "Number of customers",
                        "Gross profit margin"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "When raising Series A funding, what valuation multiple is typically applied to ARR?",
                    options: [
                        "2-5x ARR",
                        "10-20x ARR",
                        "25-50x ARR",
                        "100x ARR"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "What is the biggest challenge in building a global remote team?",
                    options: [
                        "Time zone coordination",
                        "Maintaining company culture and communication",
                        "Payroll complexity",
                        "Legal compliance in multiple countries"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "In enterprise sales, what is the typical sales cycle length for deals over $100K?",
                    options: [
                        "1-3 months",
                        "6-18 months",
                        "2-3 years",
                        "Less than 1 month"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "What is the most critical factor for successful international expansion?",
                    options: [
                        "Having local offices",
                        "Understanding regulatory requirements and local market dynamics",
                        "Hiring local sales teams",
                        "Translating the product"
                    ],
                    correct: 1,
                    points: 3
                },
                {
                    question: "What does IPO stand for?",
                    options: [
                        "Initial Public Offering",
                        "International Product Offering",
                        "Internal Process Optimization",
                        "Investment Portfolio Overview"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What is venture capital?",
                    options: [
                        "Funding provided to startups and small businesses with growth potential",
                        "Money borrowed from banks",
                        "Government grants for businesses",
                        "Personal savings invested in business"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What does CEO stand for?",
                    options: [
                        "Chief Executive Officer",
                        "Chief Economic Officer",
                        "Corporate Executive Officer",
                        "Central Executive Officer"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What is a business model?",
                    options: [
                        "A plan for how a company will make money",
                        "A physical model of the business",
                        "A list of company employees",
                        "A marketing strategy"
                    ],
                    correct: 0,
                    points: 3
                },
                {
                    question: "What is market capitalization?",
                    options: [
                        "The total value of a company's shares in the stock market",
                        "The amount of capital invested in marketing",
                        "The maximum capacity of a market",
                        "The capital required to enter a market"
                    ],
                    correct: 0,
                    points: 3
                }
            ]
        };

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} fixed top-4 right-4 z-50 max-w-md`;
            alertDiv.innerHTML = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function requestCameraFirst() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    cameraGranted = true;
                    mediaStream = stream;
                    updateAccessStatus();
                    showAlert('✅ Camera access granted successfully!', 'success');
                })
                .catch(function(err) {
                    showAlert('❌ Camera access is required to proceed.', 'danger');
                });
        }

        function requestMicFirst() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    micGranted = true;
                    if (mediaStream) {
                        // Add audio track to existing stream
                        stream.getAudioTracks().forEach(track => {
                            mediaStream.addTrack(track);
                        });
                    } else {
                        mediaStream = stream;
                    }
                    updateAccessStatus();
                    showAlert('✅ Microphone access granted successfully!', 'success');
                })
                .catch(function(err) {
                    showAlert('❌ Microphone access is required to proceed.', 'danger');
                });
        }

        function updateAccessStatus() {
            const statusDiv = document.getElementById('accessStatus');
            let status = '<div class="space-y-2">';
            
            if (cameraGranted) {
                status += '<div class="text-green-600">✅ Camera: Enabled</div>';
            } else {
                status += '<div class="text-red-600">❌ Camera: Required</div>';
            }
            
            if (micGranted) {
                status += '<div class="text-green-600">✅ Microphone: Enabled</div>';
            } else {
                status += '<div class="text-red-600">❌ Microphone: Required</div>';
            }
            
            status += '</div>';
            statusDiv.innerHTML = status;
            
            if (cameraGranted && micGranted) {
                document.getElementById('proceedBtn').classList.remove('hidden');
            }
        }

        function showWelcome() {
            document.getElementById('cameraScreen').classList.add('hidden');
            document.getElementById('welcomeScreen').classList.remove('hidden');
        }

        // Page visibility detection
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && currentQuestion >= 0 && currentQuestion < 10 && !document.getElementById('assessmentScreen').classList.contains('hidden')) {
                // User left the page during assessment - shuffle questions
                shuffleQuestions();
                showAlert('⚠️ Security Alert: Page focus lost! Questions have been reshuffled for exam integrity.', 'warning');
            }
            
            // Interview mode - more strict
            if (document.hidden && isInterviewMode && !document.getElementById('interviewScreen').classList.contains('hidden')) {
                // User left during interview - shuffle and restart
                shuffleInterviewQuestions();
                currentInterviewQuestion = 0;
                interviewScore = 0;
                interviewAnswers = [];
                loadInterviewQuestion();
                showAlert('🚨 CRITICAL: Page focus lost during interview! Questions reshuffled and restarted!', 'danger');
            }
        });

        // Prevent right-click and keyboard shortcuts
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        document.addEventListener('keydown', function(e) {
            // Prevent F12, Ctrl+Shift+I, Ctrl+U, etc.
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                (e.ctrlKey && e.key === 'u')) {
                e.preventDefault();
                showAlert('⚠️ Developer tools are disabled during the assessment.', 'warning');
            }
        });

        function shuffleQuestions() {
            const currentBank = questionBanks[userLevel];
            
            // Shuffle questions
            for (let i = currentBank.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentBank[i], currentBank[j]] = [currentBank[j], currentBank[i]];
            }
            
            // Randomize answer positions for each question
            questions = currentBank.map(question => {
                const shuffledQuestion = { ...question };
                const correctAnswer = shuffledQuestion.options[shuffledQuestion.correct];
                
                // Shuffle options array
                const shuffledOptions = [...shuffledQuestion.options];
                for (let i = shuffledOptions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
                }
                
                // Find new position of correct answer
                const newCorrectIndex = shuffledOptions.indexOf(correctAnswer);
                
                return {
                    ...shuffledQuestion,
                    options: shuffledOptions,
                    correct: newCorrectIndex
                };
            });
        }

        function startVerification() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('assessmentScreen').classList.remove('hidden');
            
            // Determine user level based on random selection for demo
            const levels = ['manager', 'director', 'ceo'];
            userLevel = levels[Math.floor(Math.random() * levels.length)];
            document.getElementById('currentLevel').textContent = userLevel.charAt(0).toUpperCase() + userLevel.slice(1);
            
            shuffleQuestions();
            loadQuestion();
            updateProgress();
        }

        function loadQuestion() {
            const question = questions[currentQuestion];
            document.getElementById('questionNumber').textContent = currentQuestion + 1;
            document.getElementById('questionText').textContent = question.question;
            
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="radio-option flex items-center cursor-pointer">
                        <input type="radio" name="answer" value="${index}" class="mr-3">
                        <span>${option}</span>
                    </label>
                `;
                container.appendChild(div);
            });
            
            // Add event listeners
            const radios = container.querySelectorAll('input[type="radio"]');
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Remove selected class from all options
                    container.querySelectorAll('.radio-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Add selected class to current option
                    this.closest('.radio-option').classList.add('selected');
                    
                    document.getElementById('nextBtn').disabled = false;
                    document.getElementById('nextBtn').classList.remove('opacity-50');
                });
            });
            
            updateButtons();
        }

        function nextQuestion() {
            const selected = document.querySelector('input[name="answer"]:checked');
            if (!selected) return;
            
            const answer = parseInt(selected.value);
            const question = questions[currentQuestion];
            
            userAnswers[currentQuestion] = answer;
            
            // Calculate score
            if (answer === question.correct) {
                score += question.points;
            } else if (Math.abs(answer - question.correct) <= 1) {
                score += 1; // Partial credit
            }
            
            document.getElementById('currentScore').textContent = score;
            
            currentQuestion++;
            
            if (currentQuestion >= questions.length) {
                showResults();
            } else {
                loadQuestion();
                updateProgress();
            }
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                loadQuestion();
                updateProgress();
            }
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentQuestion === 0;
            nextBtn.disabled = true;
            nextBtn.classList.add('opacity-50');
            
            if (currentQuestion === 0) {
                prevBtn.classList.add('opacity-50');
                prevBtn.style.cursor = 'not-allowed';
            } else {
                prevBtn.classList.remove('opacity-50');
                prevBtn.style.cursor = 'pointer';
            }
            
            nextBtn.style.cursor = 'not-allowed';
        }

        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 50; // 50% for assessment
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = Math.round(progress) + '%';
        }

        function showResults() {
            document.getElementById('assessmentScreen').classList.add('hidden');
            
            if (score >= 18) {
                // Show details form
                document.getElementById('detailsScreen').classList.remove('hidden');
                updateProgress();
                const progress = 75; // 75% after assessment
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = progress + '%';
            } else {
                // Show failure
                document.getElementById('resultsScreen').classList.remove('hidden');
                document.getElementById('failResult').classList.remove('hidden');
                document.getElementById('failScore').textContent = score;
            }
        }

        async function submitDetails() {
            const fullName = document.getElementById('fullName').value;
            const businessEmail = document.getElementById('businessEmail').value;
            const companyName = document.getElementById('companyName').value;
            const jobTitle = document.getElementById('jobTitle').value;
            const country = document.getElementById('country').value;
            const experience = document.getElementById('experience').value;
            
            if (!fullName || !businessEmail || !companyName || !jobTitle || !country || !experience) {
                alert('Please fill in all required fields.');
                return;
            }
            
            showAlert('💾 Saving application to Firebase...', 'info');
            
            // Generate application ID
            const applicationId = 'WO-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();
            
            // Create candidate data object
            const candidateData = {
                id: applicationId,
                status: 'pending',
                submitDate: new Date().toLocaleDateString(),
                fullName: fullName,
                email: businessEmail,
                company: companyName,
                position: jobTitle,
                country: country,
                experience: experience,
                score: score + '/30',
                level: userLevel,
                phone: 'Not provided',
                allotmentNumber: null,
                interviewScore: null
            };
            
            // Save to Firebase
            const saved = await saveCandidateToFirebase(candidateData);
            
            if (saved) {
                showAlert('✅ Application saved to Firebase successfully!', 'success');
            }
            
            document.getElementById('detailsScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            document.getElementById('successResult').classList.remove('hidden');
            document.getElementById('finalScore').textContent = score;
            document.getElementById('applicationId').textContent = applicationId;
            
            // Complete progress
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressText').textContent = '100%';
        }

        function restartVerification() {
            currentQuestion = 0;
            score = 0;
            userAnswers = [];
            cameraGranted = false;
            micGranted = false;
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('failResult').classList.add('hidden');
            document.getElementById('cameraScreen').classList.remove('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('proceedBtn').classList.add('hidden');
            
            updateAccessStatus();
        }

        // Admin Functions
        let allCandidates = [];
        let selectedCandidates = [];

        async function showAdminPanel() {
            if (!isAuthenticated) {
                showAuthScreen();
                return;
            }
            hideAllScreens();
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('adminScreen').classList.remove('hidden');
            await loadAdminData();
        }

        async function loadAdminData() {
            showAlert('🔄 Loading candidate data from Firebase...', 'info');
            
            try {
                allCandidates = await getAllCandidatesFromFirebase();
                
                if (allCandidates.length === 0) {
                    showAlert('⚠️ No candidate data found in Firebase', 'warning');
                    return;
                }
                
                updateAdminStats();
                displayCandidatesTable();
                showAlert('✅ Data loaded successfully from Firebase!', 'success');
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                showAlert('❌ Error loading data from Firebase', 'danger');
            }
        }

        function updateAdminStats() {
            const total = allCandidates.length;
            const pending = allCandidates.filter(c => c.status === 'pending').length;
            const approved = allCandidates.filter(c => c.status === 'approved' || c.status === 'interview_ready' || c.status === 'completed').length;
            const rejected = allCandidates.filter(c => c.status === 'rejected').length;
            
            document.getElementById('totalApplications').textContent = total;
            document.getElementById('pendingApplications').textContent = pending;
            document.getElementById('approvedApplications').textContent = approved;
            document.getElementById('rejectedApplications').textContent = rejected;
        }

        function displayCandidatesTable() {
            const tbody = document.getElementById('adminTableBody');
            const searchTerm = document.getElementById('adminSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredCandidates = allCandidates;
            
            // Apply search filter
            if (searchTerm) {
                filteredCandidates = filteredCandidates.filter(candidate => 
                    candidate.id.toLowerCase().includes(searchTerm) ||
                    candidate.fullName.toLowerCase().includes(searchTerm) ||
                    candidate.email.toLowerCase().includes(searchTerm) ||
                    candidate.company.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply status filter
            if (statusFilter) {
                filteredCandidates = filteredCandidates.filter(candidate => 
                    candidate.status === statusFilter
                );
            }
            
            tbody.innerHTML = '';
            
            filteredCandidates.forEach(candidate => {
                const statusClass = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'approved': 'bg-green-100 text-green-800',
                    'rejected': 'bg-red-100 text-red-800',
                    'interview_ready': 'bg-purple-100 text-purple-800',
                    'completed': 'bg-blue-100 text-blue-800'
                };
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="border border-gray-300 p-3">
                        <input type="checkbox" class="candidate-checkbox mr-2" value="${candidate.id}">
                        <span class="font-mono text-sm">${candidate.id}</span>
                    </td>
                    <td class="border border-gray-300 p-3">
                        <div class="font-medium">${candidate.fullName}</div>
                        <div class="text-sm text-gray-600">${candidate.email}</div>
                    </td>
                    <td class="border border-gray-300 p-3">
                        <div class="font-medium">${candidate.company}</div>
                        <div class="text-sm text-gray-600">${candidate.position}</div>
                    </td>
                    <td class="border border-gray-300 p-3 text-center">
                        <span class="font-bold">${candidate.score}</span>
                    </td>
                    <td class="border border-gray-300 p-3">
                        <span class="px-2 py-1 rounded text-xs font-medium ${statusClass[candidate.status] || 'bg-gray-100 text-gray-800'}">
                            ${candidate.status.charAt(0).toUpperCase() + candidate.status.slice(1)}
                        </span>
                    </td>
                    <td class="border border-gray-300 p-3 text-sm">
                        ${candidate.submitDate}
                    </td>
                    <td class="border border-gray-300 p-3 text-center">
                        <div class="flex flex-wrap gap-1 justify-center">
                            ${candidate.status === 'pending' ? `
                                <button onclick="approveCandidate('${candidate.id}')" class="btn-success text-xs px-2 py-1">✅ Approve</button>
                                <button onclick="rejectCandidate('${candidate.id}')" class="btn-secondary text-xs px-2 py-1">❌ Reject</button>
                            ` : ''}
                            <button onclick="viewCandidate('${candidate.id}')" class="btn-primary text-xs px-2 py-1">👁️ View</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners for checkboxes
            document.querySelectorAll('.candidate-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCandidates);
            });
        }

        function updateSelectedCandidates() {
            selectedCandidates = Array.from(document.querySelectorAll('.candidate-checkbox:checked'))
                .map(checkbox => checkbox.value);
        }

        async function approveCandidate(candidateId) {
            if (!confirm('Are you sure you want to approve this candidate?')) return;
            
            showAlert('🔄 Approving candidate...', 'info');
            
            try {
                const updateData = {
                    status: 'approved',
                    approvedAt: firebase.firestore.Timestamp.now(),
                    approvedBy: currentUser.email
                };
                
                await updateCandidateInFirebase(candidateId, updateData);
                
                // Update local data
                const candidate = allCandidates.find(c => c.id === candidateId);
                if (candidate) {
                    candidate.status = 'approved';
                    candidate.approvedAt = new Date();
                    candidate.approvedBy = currentUser.email;
                }
                
                updateAdminStats();
                displayCandidatesTable();
                showAlert('✅ Candidate approved successfully!', 'success');
                
            } catch (error) {
                console.error('Error approving candidate:', error);
                showAlert('❌ Error approving candidate', 'danger');
            }
        }

        async function rejectCandidate(candidateId) {
            const reason = prompt('Enter rejection reason (optional):');
            if (reason === null) return; // User cancelled
            
            showAlert('🔄 Rejecting candidate...', 'info');
            
            try {
                const updateData = {
                    status: 'rejected',
                    rejectedAt: firebase.firestore.Timestamp.now(),
                    rejectedBy: currentUser.email,
                    rejectionReason: reason || 'Did not meet minimum requirements'
                };
                
                await updateCandidateInFirebase(candidateId, updateData);
                
                // Update local data
                const candidate = allCandidates.find(c => c.id === candidateId);
                if (candidate) {
                    candidate.status = 'rejected';
                    candidate.rejectedAt = new Date();
                    candidate.rejectedBy = currentUser.email;
                    candidate.rejectionReason = reason || 'Did not meet minimum requirements';
                }
                
                updateAdminStats();
                displayCandidatesTable();
                showAlert('❌ Candidate rejected successfully!', 'success');
                
            } catch (error) {
                console.error('Error rejecting candidate:', error);
                showAlert('❌ Error rejecting candidate', 'danger');
            }
        }

        function viewCandidate(candidateId) {
            const candidate = allCandidates.find(c => c.id === candidateId);
            if (!candidate) return;
            
            const details = `
                📋 CANDIDATE DETAILS
                ═══════════════════════════════════════
                
                🆔 ID: ${candidate.id}
                👤 Name: ${candidate.fullName}
                📧 Email: ${candidate.email}
                🏢 Company: ${candidate.company}
                💼 Position: ${candidate.position}
                🌍 Country: ${candidate.country}
                ⏱️ Experience: ${candidate.experience}
                📊 Score: ${candidate.score}
                📈 Level: ${candidate.level}
                📅 Applied: ${candidate.submitDate}
                🔄 Status: ${candidate.status.toUpperCase()}
                
                ${candidate.rejectionReason ? `❌ Rejection Reason: ${candidate.rejectionReason}` : ''}
                ${candidate.allotmentNumber ? `🎫 Allotment: ${candidate.allotmentNumber}` : ''}
                ${candidate.interviewScore ? `🎤 Interview: ${candidate.interviewScore}` : ''}
                ${candidate.approvedBy ? `✅ Approved by: ${candidate.approvedBy}` : ''}
                ${candidate.rejectedBy ? `❌ Rejected by: ${candidate.rejectedBy}` : ''}
            `;
            
            alert(details);
        }

        async function bulkApprove() {
            if (selectedCandidates.length === 0) {
                showAlert('⚠️ Please select candidates to approve', 'warning');
                return;
            }
            
            if (!confirm(`Approve ${selectedCandidates.length} selected candidates?`)) return;
            
            showAlert('🔄 Bulk approving candidates...', 'info');
            
            try {
                const promises = selectedCandidates.map(candidateId => {
                    const updateData = {
                        status: 'approved',
                        approvedAt: firebase.firestore.Timestamp.now(),
                        approvedBy: currentUser.email
                    };
                    return updateCandidateInFirebase(candidateId, updateData);
                });
                
                await Promise.all(promises);
                
                // Update local data
                selectedCandidates.forEach(candidateId => {
                    const candidate = allCandidates.find(c => c.id === candidateId);
                    if (candidate) {
                        candidate.status = 'approved';
                        candidate.approvedAt = new Date();
                        candidate.approvedBy = currentUser.email;
                    }
                });
                
                selectedCandidates = [];
                updateAdminStats();
                displayCandidatesTable();
                showAlert(`✅ ${promises.length} candidates approved successfully!`, 'success');
                
            } catch (error) {
                console.error('Error bulk approving:', error);
                showAlert('❌ Error during bulk approval', 'danger');
            }
        }

        async function bulkReject() {
            if (selectedCandidates.length === 0) {
                showAlert('⚠️ Please select candidates to reject', 'warning');
                return;
            }
            
            const reason = prompt('Enter rejection reason for all selected candidates:');
            if (reason === null) return;
            
            if (!confirm(`Reject ${selectedCandidates.length} selected candidates?`)) return;
            
            showAlert('🔄 Bulk rejecting candidates...', 'info');
            
            try {
                const promises = selectedCandidates.map(candidateId => {
                    const updateData = {
                        status: 'rejected',
                        rejectedAt: firebase.firestore.Timestamp.now(),
                        rejectedBy: currentUser.email,
                        rejectionReason: reason || 'Did not meet minimum requirements'
                    };
                    return updateCandidateInFirebase(candidateId, updateData);
                });
                
                await Promise.all(promises);
                
                // Update local data
                selectedCandidates.forEach(candidateId => {
                    const candidate = allCandidates.find(c => c.id === candidateId);
                    if (candidate) {
                        candidate.status = 'rejected';
                        candidate.rejectedAt = new Date();
                        candidate.rejectedBy = currentUser.email;
                        candidate.rejectionReason = reason || 'Did not meet minimum requirements';
                    }
                });
                
                selectedCandidates = [];
                updateAdminStats();
                displayCandidatesTable();
                showAlert(`❌ ${promises.length} candidates rejected successfully!`, 'success');
                
            } catch (error) {
                console.error('Error bulk rejecting:', error);
                showAlert('❌ Error during bulk rejection', 'danger');
            }
        }

        function exportData() {
            if (allCandidates.length === 0) {
                showAlert('⚠️ No data to export', 'warning');
                return;
            }
            
            const csvContent = [
                'Application ID,Full Name,Email,Company,Position,Country,Experience,Score,Status,Submit Date,Approved By,Rejected By,Rejection Reason',
                ...allCandidates.map(candidate => [
                    candidate.id,
                    candidate.fullName,
                    candidate.email,
                    candidate.company,
                    candidate.position,
                    candidate.country,
                    candidate.experience,
                    candidate.score,
                    candidate.status,
                    candidate.submitDate,
                    candidate.approvedBy || '',
                    candidate.rejectedBy || '',
                    candidate.rejectionReason || ''
                ].map(field => `"${field}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `WebOrion_Candidates_Export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showAlert('📊 Data exported successfully!', 'success');
        }

        // Add search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('adminSearch');
            const statusFilter = document.getElementById('statusFilter');
            
            if (searchInput) {
                searchInput.addEventListener('input', displayCandidatesTable);
            }
            if (statusFilter) {
                statusFilter.addEventListener('change', displayCandidatesTable);
            }
        });

        // Navigation functions
        function showHome() {
            if (!isAuthenticated) {
                showAuthScreen();
                return;
            }
            hideAllScreens();
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('cameraScreen').classList.remove('hidden');
            isInterviewMode = false;
        }
        
        function showTracker() {
            if (!isAuthenticated) {
                showAuthScreen();
                return;
            }
            hideAllScreens();
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('trackerScreen').classList.remove('hidden');
            isInterviewMode = false;
        }
        
        function hideAllScreens() {
            const screens = ['authScreen', 'mainApp', 'cameraScreen', 'welcomeScreen', 'assessmentScreen', 'detailsScreen', 'resultsScreen', 'trackerScreen', 'interviewScreen', 'adminScreen'];
            screens.forEach(screen => {
                const element = document.getElementById(screen);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                progressContainer.classList.add('hidden');
            }
        }
        
        // Application tracking functions
        async function trackApplication() {
            const trackingId = document.getElementById('trackingId').value.trim().toUpperCase();
            if (!trackingId) {
                showAlert('Please enter a valid Application ID', 'warning');
                return;
            }
            
            showAlert('🔍 Searching Firebase database...', 'info');
            
            // Look up in Firebase database
            const candidateData = await getCandidateFromFirebase(trackingId);
            
            if (!candidateData) {
                showAlert('❌ Application ID not found in Firebase. Please check your ID and try again.', 'danger');
                return;
            }
            
            displayApplicationStatus(candidateData);
            showAlert('✅ Application found in Firebase! Displaying details...', 'success');
        }
        
        function displayApplicationStatus(data) {
            document.getElementById('trackingResult').classList.remove('hidden');
            document.getElementById('submitDate').textContent = data.submitDate;
            
            // Update status badge and steps based on real data
            const statusBadge = document.getElementById('statusBadge');
            
            // Reset all steps
            document.getElementById('reviewStep').style.display = 'flex';
            document.getElementById('approvedStep').style.display = 'none';
            document.getElementById('allotmentStep').style.display = 'none';
            document.getElementById('interviewStep').style.display = 'none';
            document.getElementById('allotmentInput').classList.add('hidden');
            document.getElementById('interviewButton').classList.add('hidden');
            
            if (data.status === 'pending') {
                statusBadge.textContent = 'Under Review';
                statusBadge.className = 'px-3 py-1 rounded text-sm font-medium bg-yellow-100 text-yellow-800';
            } else if (data.status === 'rejected') {
                statusBadge.textContent = 'Application Rejected';
                statusBadge.className = 'px-3 py-1 rounded text-sm font-medium bg-red-100 text-red-800';
                document.getElementById('reviewStep').innerHTML = `
                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">❌</div>
                    <div>
                        <p class="font-medium text-red-600">Application Rejected</p>
                        <p class="text-sm text-red-600">${data.rejectionReason || 'Application did not meet requirements'}</p>
                    </div>
                `;
            } else if (data.status === 'approved') {
                statusBadge.textContent = 'Approved';
                statusBadge.className = 'px-3 py-1 rounded text-sm font-medium bg-green-100 text-green-800';
                document.getElementById('reviewStep').style.display = 'none';
                document.getElementById('approvedStep').style.display = 'flex';
                document.getElementById('allotmentStep').style.display = 'flex';
                document.getElementById('allotmentInput').classList.remove('hidden');
            } else if (data.status === 'interview_ready') {
                statusBadge.textContent = 'Interview Ready';
                statusBadge.className = 'px-3 py-1 rounded text-sm font-medium bg-purple-100 text-purple-800';
                document.getElementById('reviewStep').style.display = 'none';
                document.getElementById('approvedStep').style.display = 'flex';
                document.getElementById('allotmentStep').style.display = 'flex';
                document.getElementById('interviewStep').style.display = 'flex';
                document.getElementById('allotmentInput').classList.add('hidden');
                document.getElementById('interviewButton').classList.remove('hidden');
            } else if (data.status === 'completed') {
                statusBadge.textContent = 'Completed';
                statusBadge.className = 'px-3 py-1 rounded text-sm font-medium bg-blue-100 text-blue-800';
                document.getElementById('reviewStep').style.display = 'none';
                document.getElementById('approvedStep').style.display = 'flex';
                document.getElementById('allotmentStep').style.display = 'flex';
                document.getElementById('interviewStep').style.display = 'flex';
                
                // Show completed status
                const completedStep = document.createElement('div');
                completedStep.className = 'flex items-center';
                completedStep.innerHTML = `
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">🎉</div>
                    <div>
                        <p class="font-medium">Process Completed</p>
                        <p class="text-sm text-gray-600">${data.finalStatus || 'All assessments completed successfully'}</p>
                    </div>
                `;
                document.getElementById('progressSteps').appendChild(completedStep);
            }
            
            // Populate application details with real candidate information
            const detailsDiv = document.getElementById('applicationDetails');
            detailsDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div><strong>Application ID:</strong> ${data.id}</div>
                    <div><strong>Submit Date:</strong> ${data.submitDate}</div>
                    <div><strong>Full Name:</strong> ${data.fullName}</div>
                    <div><strong>Email:</strong> ${data.email}</div>
                    <div><strong>Company:</strong> ${data.company}</div>
                    <div><strong>Position:</strong> ${data.position}</div>
                    <div><strong>Country:</strong> ${data.country}</div>
                    <div><strong>Experience:</strong> ${data.experience}</div>
                    <div><strong>Assessment Score:</strong> ${data.score}</div>
                    <div><strong>Level:</strong> ${data.level.charAt(0).toUpperCase() + data.level.slice(1)}</div>
                    <div><strong>Phone:</strong> ${data.phone}</div>
                    <div><strong>Status:</strong> ${statusBadge.textContent}</div>
                    ${data.allotmentNumber ? `<div><strong>Allotment Number:</strong> ${data.allotmentNumber}</div>` : ''}
                    ${data.acknowledgmentNumber ? `<div><strong>Acknowledgment Number:</strong> <span class="font-mono text-green-600">${data.acknowledgmentNumber}</span></div>` : ''}
                    ${data.interviewScore ? `<div><strong>Interview Score:</strong> ${data.interviewScore}</div>` : ''}
                    ${data.finalStatus ? `<div class="md:col-span-2"><strong>Final Status:</strong> <span class="text-blue-600 font-semibold">${data.finalStatus}</span></div>` : ''}
                </div>
            `;
            
            applicationData = data;
        }
        
        async function submitAllotment() {
            const allotmentNumber = document.getElementById('allotmentNumber').value.trim();
            if (!allotmentNumber) {
                showAlert('Please enter your allotment number', 'warning');
                return;
            }
            
            showAlert('💾 Processing allotment number...', 'info');
            
            // Generate acknowledgment number
            const acknowledgmentNumber = 'ACK-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // Update candidate data in Firebase
            if (applicationData.id) {
                const updateData = {
                    allotmentNumber: allotmentNumber,
                    acknowledgmentNumber: acknowledgmentNumber,
                    status: 'interview_ready',
                    allotmentDate: new Date().toISOString()
                };
                
                const updated = await updateCandidateInFirebase(applicationData.id, updateData);
                
                if (updated) {
                    // Update local data
                    applicationData.allotmentNumber = allotmentNumber;
                    applicationData.acknowledgmentNumber = acknowledgmentNumber;
                    applicationData.status = 'interview_ready';
                    showAlert('✅ Data saved to Firebase successfully!', 'success');
                }
            }
            
            // Update display
            document.getElementById('allotmentInput').classList.add('hidden');
            document.getElementById('interviewStep').style.display = 'flex';
            document.getElementById('interviewButton').classList.remove('hidden');
            
            // Show acknowledgment number
            const acknowledgmentDiv = document.createElement('div');
            acknowledgmentDiv.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded';
            acknowledgmentDiv.innerHTML = `
                <h4 class="font-bold text-green-800 mb-2">✅ Acknowledgment Generated</h4>
                <p class="text-sm text-green-700 mb-2">Your Acknowledgment Number:</p>
                <p class="font-mono text-lg font-bold text-green-800 bg-white p-2 rounded border">${acknowledgmentNumber}</p>
                <p class="text-xs text-green-600 mt-2">Please save this number for your records</p>
            `;
            document.getElementById('interviewButton').parentNode.insertBefore(acknowledgmentDiv, document.getElementById('interviewButton'));
            
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = 'Interview Ready';
            statusBadge.className = 'px-3 py-1 rounded text-sm font-medium bg-purple-100 text-purple-800';
            
            showAlert('✅ Acknowledgment number generated! You can now start your interview.', 'success');
        }
        
        function downloadPDF() {
            if (!applicationData.id) {
                showAlert('❌ No application data found to download.', 'danger');
                return;
            }
            
            // Create professional PDF content with proper formatting
            const currentDate = new Date().toLocaleDateString('en-IN');
            const statusText = applicationData.status === 'rejected' ? 'REJECTED' : 
                              applicationData.status === 'approved' ? 'APPROVED' : 
                              applicationData.status === 'completed' ? 'COMPLETED' : 'UNDER REVIEW';
            
            const pdfContent = `
╔══════════════════════════════════════════════════════════════════════════════╗
║                          WEB ORION+ BUSINESS INTELLIGENCE                    ║
║                              APPLICATION CERTIFICATE                         ║
╚══════════════════════════════════════════════════════════════════════════════╝

📋 APPLICATION DETAILS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🆔 Application ID:        ${applicationData.id}
📅 Submission Date:       ${applicationData.submitDate}
📊 Current Status:        ${statusText}
🏆 Assessment Score:      ${applicationData.score}

👤 CANDIDATE INFORMATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 Full Name:            ${applicationData.fullName}
📧 Email Address:        ${applicationData.email}
📱 Phone Number:         ${applicationData.phone}
🌍 Country:              ${applicationData.country}

🏢 PROFESSIONAL DETAILS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🏭 Company Name:         ${applicationData.company}
💼 Position:             ${applicationData.position}
⏱️ Experience:           ${applicationData.experience}
📈 Assessment Level:     ${applicationData.level.charAt(0).toUpperCase() + applicationData.level.slice(1)}

🎯 ASSESSMENT RESULTS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 Assessment Score:     ${applicationData.score}
🎖️ Performance Level:    ${applicationData.score >= '25/30' ? 'EXCELLENT' : applicationData.score >= '20/30' ? 'GOOD' : applicationData.score >= '15/30' ? 'AVERAGE' : 'NEEDS IMPROVEMENT'}
${applicationData.allotmentNumber ? `🎫 Allotment Number:     ${applicationData.allotmentNumber}` : ''}
${applicationData.acknowledgmentNumber ? `✅ Acknowledgment No:    ${applicationData.acknowledgmentNumber}` : ''}
${applicationData.interviewScore ? `🎤 Interview Score:      ${applicationData.interviewScore}` : ''}

📋 APPLICATION STATUS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔄 Current Status:       ${statusText}
${applicationData.status === 'rejected' ? `❌ Rejection Reason:     ${applicationData.rejectionReason || 'Did not meet minimum requirements'}` : ''}
${applicationData.finalStatus ? `🏆 Final Result:         ${applicationData.finalStatus}` : ''}
📅 Last Updated:         ${currentDate}

${applicationData.status === 'approved' || applicationData.status === 'completed' ? `
🎉 CONGRATULATIONS!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ Your application has been successfully processed.
🚀 You are now eligible for Web Orion+ Business Intelligence Platform access.
📧 Further instructions will be sent to your registered email address.
` : applicationData.status === 'rejected' ? `
❌ APPLICATION REJECTED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Unfortunately, your application did not meet our current requirements.
You may reapply after addressing the feedback provided.
` : `
⏳ APPLICATION UNDER REVIEW
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Your application is currently being reviewed by our team.
You will receive an email notification once the review is complete.
`}

🔒 SECURITY & VERIFICATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🛡️ Document Authenticity: VERIFIED
🔐 Digital Signature:     WEB-ORION-${Date.now().toString(36).toUpperCase()}
📅 Generated On:          ${currentDate}
🌐 Platform:              ai.oriontec.xyz
🔒 SSL Secured:           ✅ VERIFIED

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    © 2024 Web Orion+ Business Intelligence Platform
                           All Rights Reserved | Confidential Document
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️  IMPORTANT NOTICE:
This is an official document generated by Web Orion+ platform. Any unauthorized
reproduction or modification of this document is strictly prohibited.

For verification, please visit: https://ai.oriontec.xyz/verify
Verification Code: ${applicationData.id}-${Date.now().toString(36).toUpperCase()}

📞 Support: support@oriontec.xyz | 🌐 Website: https://ai.oriontec.xyz
            `;
            
            // Create and download file with proper formatting
            const blob = new Blob([pdfContent], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `WebOrion_Certificate_${applicationData.id}_${currentDate.replace(/\//g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showAlert('📄 Professional certificate downloaded successfully!', 'success');
        }
        
        // Interview functions
        function startInterview() {
            hideAllScreens();
            document.getElementById('interviewScreen').classList.remove('hidden');
            isInterviewMode = true;
            
            currentInterviewQuestion = 0;
            interviewScore = 0;
            interviewAnswers = [];
            
            shuffleInterviewQuestions();
            loadInterviewQuestion();
        }
        
        function shuffleInterviewQuestions() {
            // Shuffle questions
            const shuffledBank = [...interviewQuestionBank];
            for (let i = shuffledBank.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledBank[i], shuffledBank[j]] = [shuffledBank[j], shuffledBank[i]];
            }
            
            // Randomize answer positions for each interview question
            interviewQuestions = shuffledBank.map(question => {
                const shuffledQuestion = { ...question };
                const correctAnswer = shuffledQuestion.options[shuffledQuestion.correct];
                
                // Shuffle options array
                const shuffledOptions = [...shuffledQuestion.options];
                for (let i = shuffledOptions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
                }
                
                // Find new position of correct answer
                const newCorrectIndex = shuffledOptions.indexOf(correctAnswer);
                
                return {
                    ...shuffledQuestion,
                    options: shuffledOptions,
                    correct: newCorrectIndex
                };
            });
        }
        
        function loadInterviewQuestion() {
            const question = interviewQuestions[currentInterviewQuestion];
            document.getElementById('interviewQuestionNumber').textContent = currentInterviewQuestion + 1;
            document.getElementById('interviewQuestionText').textContent = question.question;
            
            const container = document.getElementById('interviewOptionsContainer');
            container.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="radio-option flex items-center cursor-pointer">
                        <input type="radio" name="interviewAnswer" value="${index}" class="mr-3">
                        <span>${option}</span>
                    </label>
                `;
                container.appendChild(div);
            });
            
            // Add event listeners
            const radios = container.querySelectorAll('input[type="radio"]');
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    container.querySelectorAll('.radio-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.closest('.radio-option').classList.add('selected');
                    
                    document.getElementById('interviewNextBtn').disabled = false;
                    document.getElementById('interviewNextBtn').classList.remove('opacity-50');
                });
            });
            
            updateInterviewButtons();
        }
        
        function nextInterviewQuestion() {
            const selected = document.querySelector('input[name="interviewAnswer"]:checked');
            if (!selected) return;
            
            const answer = parseInt(selected.value);
            const question = interviewQuestions[currentInterviewQuestion];
            
            interviewAnswers[currentInterviewQuestion] = answer;
            
            // Calculate score
            if (answer === question.correct) {
                interviewScore++;
            }
            
            document.getElementById('interviewScore').textContent = interviewScore;
            
            currentInterviewQuestion++;
            
            if (currentInterviewQuestion >= interviewQuestions.length) {
                showInterviewResults();
            } else {
                loadInterviewQuestion();
            }
        }
        
        function previousInterviewQuestion() {
            if (currentInterviewQuestion > 0) {
                currentInterviewQuestion--;
                loadInterviewQuestion();
            }
        }
        
        function updateInterviewButtons() {
            const prevBtn = document.getElementById('interviewPrevBtn');
            const nextBtn = document.getElementById('interviewNextBtn');
            
            prevBtn.disabled = currentInterviewQuestion === 0;
            nextBtn.disabled = true;
            nextBtn.classList.add('opacity-50');
            
            if (currentInterviewQuestion === 0) {
                prevBtn.classList.add('opacity-50');
                prevBtn.style.cursor = 'not-allowed';
            } else {
                prevBtn.classList.remove('opacity-50');
                prevBtn.style.cursor = 'pointer';
            }
            
            nextBtn.style.cursor = 'not-allowed';
        }
        
        async function showInterviewResults() {
            document.getElementById('interviewScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            isInterviewMode = false;
            
            showAlert('💾 Saving interview results to Firebase...', 'info');
            
            // Update candidate database with interview results
            if (applicationData.id) {
                const finalStatus = interviewScore >= 10 ? 'APPROVED - Full Access Granted' : 'REJECTED - Interview Failed';
                
                const updateData = {
                    interviewScore: `${interviewScore}/15`,
                    status: 'completed',
                    finalStatus: finalStatus
                };
                
                const updated = await updateCandidateInFirebase(applicationData.id, updateData);
                
                if (updated) {
                    // Update local data
                    applicationData.interviewScore = `${interviewScore}/15`;
                    applicationData.status = 'completed';
                    applicationData.finalStatus = finalStatus;
                    showAlert('✅ Interview results saved to Firebase!', 'success');
                }
            }
            
            if (interviewScore >= 10) {
                document.getElementById('interviewSuccessResult').classList.remove('hidden');
                document.getElementById('finalInterviewScore').textContent = interviewScore;
            } else {
                document.getElementById('interviewFailResult').classList.remove('hidden');
                document.getElementById('failInterviewScore').textContent = interviewScore;
            }
        }

        // Firebase Authentication System
        let isAuthenticated = false;
        let currentUser = null;

        function showAuthScreen() {
            hideAllScreens();
            document.getElementById('authScreen').classList.remove('hidden');
        }

        function showLoginForm() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Login to Web Orion+';
            document.getElementById('authSubtitle').textContent = 'Enter your credentials to access the platform';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Create Web Orion+ Account';
            document.getElementById('authSubtitle').textContent = 'Register to access our business intelligence platform';
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validatePassword(password) {
            return password.length >= 6;
        }

        // Firebase Registration
        async function registerUser() {
            const country = document.getElementById('regCountry').value;
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            // Validation
            if (!country) {
                showAlert('❌ Please select your country', 'danger');
                return;
            }

            if (!validateEmail(email)) {
                showAlert('❌ Please enter a valid email address', 'danger');
                return;
            }

            if (!validatePassword(password)) {
                showAlert('❌ Password must be at least 6 characters long', 'danger');
                return;
            }

            if (password !== confirmPassword) {
                showAlert('❌ Passwords do not match', 'danger');
                return;
            }

            if (!auth) {
                showAlert('❌ Firebase Authentication not available. Please try again later.', 'danger');
                return;
            }

            try {
                showAlert('🔄 Creating your account with Firebase...', 'info');
                
                // Create user with Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Save additional user data to Firestore
                if (db) {
                    await db.collection('users').doc(user.uid).set({
                        email: email,
                        country: country,
                        registeredAt: firebase.firestore.Timestamp.now(),
                        lastLogin: null,
                        isActive: true,
                        displayName: email.split('@')[0]
                    });
                }

                // Send email verification
                await user.sendEmailVerification();

                showAlert('✅ Account created successfully! Please check your email for verification link.', 'success');
                
                // Clear form and switch to login
                document.getElementById('registerForm').reset();
                showLoginForm();

            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = '❌ Registration failed. ';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += 'This email is already registered. Please login instead.';
                        break;
                    case 'auth/weak-password':
                        errorMessage += 'Password is too weak. Please use a stronger password.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address format.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showAlert(errorMessage, 'danger');
            }
        }

        // Firebase Login
        async function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!validateEmail(email)) {
                showAlert('❌ Please enter a valid email address', 'danger');
                return;
            }

            if (!password) {
                showAlert('❌ Please enter your password', 'danger');
                return;
            }

            if (!auth) {
                showAlert('❌ Firebase Authentication not available. Please try again later.', 'danger');
                return;
            }

            try {
                showAlert('🔄 Signing in with Firebase...', 'info');
                
                // Sign in with Firebase Auth
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Check if email is verified
                if (!user.emailVerified) {
                    showAlert('⚠️ Please verify your email address before logging in. Check your inbox for verification link.', 'warning');
                    await auth.signOut();
                    return;
                }

                // Update last login in Firestore
                if (db) {
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: firebase.firestore.Timestamp.now()
                    });
                }

                showAlert('✅ Login successful! Welcome to Web Orion+', 'success');
                
                // Clear form
                document.getElementById('loginForm').reset();
                
                // Show main app after delay
                setTimeout(() => {
                    showMainApp();
                }, 1000);

            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = '❌ Login failed. ';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage += 'No account found with this email. Please register first.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage += 'Incorrect password. Please try again.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address format.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage += 'This account has been disabled. Please contact support.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage += 'Too many failed attempts. Please try again later.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showAlert(errorMessage, 'danger');
            }
        }

        function showMainApp() {
            hideAllScreens();
            document.getElementById('mainApp').classList.remove('hidden');
            updateUserInfo();
            showHome();
        }

        async function updateUserInfo() {
            if (currentUser && db) {
                try {
                    // Get user data from Firestore
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        document.getElementById('userEmail').textContent = currentUser.email;
                        document.getElementById('userCountry').textContent = getCountryName(userData.country);
                        document.getElementById('userSince').textContent = userData.registeredAt.toDate().toLocaleDateString();
                        
                        // Check if user is admin - only specific email allowed
                        const adminEmails = ['sgursharn076@gmail.com']; // Only this email has admin access
                        if (adminEmails.includes(currentUser.email)) {
                            document.getElementById('adminBtn').style.display = 'inline-block';
                        }
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    // Fallback to basic info
                    document.getElementById('userEmail').textContent = currentUser.email;
                    document.getElementById('userCountry').textContent = 'Unknown';
                    document.getElementById('userSince').textContent = 'Recently';
                    
                    // Check admin access even in fallback
                    const adminEmails = ['sgursharn076@gmail.com'];
                    if (adminEmails.includes(currentUser.email)) {
                        document.getElementById('adminBtn').style.display = 'inline-block';
                    }
                }
            }
        }

        function getCountryName(code) {
            const countries = {
                'us': 'United States',
                'uk': 'United Kingdom',
                'ca': 'Canada',
                'au': 'Australia',
                'in': 'India',
                'de': 'Germany',
                'fr': 'France',
                'jp': 'Japan',
                'sg': 'Singapore',
                'ae': 'UAE',
                'other': 'Other'
            };
            return countries[code] || code;
        }

        async function logoutUser() {
            try {
                if (auth) {
                    await auth.signOut();
                }
                
                isAuthenticated = false;
                currentUser = null;
                
                showAlert('👋 Logged out successfully from Firebase!', 'info');
                showAuthScreen();
            } catch (error) {
                console.error('Logout error:', error);
                showAlert('❌ Error during logout. Please try again.', 'danger');
            }
        }

        // Password Reset Function
        async function resetPassword() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                showAlert('❌ Please enter your email address first', 'danger');
                return;
            }
            
            if (!validateEmail(email)) {
                showAlert('❌ Please enter a valid email address', 'danger');
                return;
            }
            
            if (!auth) {
                showAlert('❌ Firebase Authentication not available. Please try again later.', 'danger');
                return;
            }
            
            try {
                showAlert('🔄 Sending password reset email...', 'info');
                
                await auth.sendPasswordResetEmail(email);
                
                showAlert('✅ Password reset email sent! Please check your inbox and follow the instructions.', 'success');
                
            } catch (error) {
                console.error('Password reset error:', error);
                let errorMessage = '❌ Password reset failed. ';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage += 'No account found with this email address.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address format.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage += 'Too many requests. Please try again later.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showAlert(errorMessage, 'danger');
            }
        }

        // Firebase Auth State Observer
        function initializeAuthStateListener() {
            if (auth) {
                auth.onAuthStateChanged(async (user) => {
                    if (user && user.emailVerified) {
                        // User is signed in and email is verified
                        isAuthenticated = true;
                        currentUser = user;
                        console.log('✅ User authenticated:', user.email);
                        
                        if (document.getElementById('authScreen').classList.contains('hidden')) {
                            // User is already in the app, just update info
                            updateUserInfo();
                        } else {
                            // User just logged in, show main app
                            showMainApp();
                        }
                    } else {
                        // User is signed out or email not verified
                        isAuthenticated = false;
                        currentUser = null;
                        console.log('❌ User not authenticated');
                        
                        if (!document.getElementById('authScreen').classList.contains('hidden')) {
                            // Already on auth screen, do nothing
                            return;
                        }
                        
                        showAuthScreen();
                    }
                });
            }
        }

        // Initialize
        window.onload = function() {
            // Initialize Firebase Auth State Listener
            initializeAuthStateListener();
            
            // Show auth screen initially (Firebase will handle auto-login)
            showAuthScreen();
            
            updateAccessStatus();
            
            // SSL connection is secure for ai.oriontec.xyz
            if (location.hostname === 'ai.oriontec.xyz') {
                showAlert('🔒 Secure SSL connection verified for ai.oriontec.xyz', 'success');
            }
            
            // Initialize Firebase with sample data
            initializeSampleData();
            
            // Show Firebase connection status
            setTimeout(() => {
                if (db && auth) {
                    showAlert('🔥 Firebase Authentication & Database connected!', 'success');
                } else if (db) {
                    showAlert('🔥 Firebase Database connected (Auth unavailable)', 'warning');
                } else {
                    showAlert('⚠️ Using local storage - Firebase connection unavailable', 'warning');
                }
            }, 1000);
        };
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967eb41905845a26',t:'MTc1Mzk4MTc2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
